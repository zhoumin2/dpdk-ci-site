# Generated by Django 2.0.10 on 2019-02-04 16:58

# This a modified migration that includes several migrations to
# change from a branch string to a branch foreign key.

from django.core.exceptions import ObjectDoesNotExist
from django.db import migrations, models
import django.db.models.deletion


def link_branches(apps, schema_editor):
    db_alias = schema_editor.connection.alias
    Branch = apps.get_model('results', 'Branch')
    PatchSet = apps.get_model('results', 'Patchset')
    Tarball = apps.get_model('results', 'Tarball')
    TestRun = apps.get_model('results', 'TestRun')
    for model in [Tarball, PatchSet, TestRun]:
        for item in model.objects.using(db_alias).all():
            if not item.branch:
                continue
            try:
                branch = Branch.objects.using(db_alias).get(name=item.branch)
            except ObjectDoesNotExist as e:
                print(f'Branch name "{item.branch}" from {model.__name__}:{item.pk} '
                      'does not exist!')
                raise e
            item.branch_link = branch
            item.save()


class Migration(migrations.Migration):

    dependencies = [
        ('results', '0029_auto_20190128_2037'),
    ]

    operations = [
        # Migration 1
        migrations.AddField(
            model_name='patchset',
            name='branch_link',
            field=models.ForeignKey(blank=True, help_text='The branch that the patch set was applied to. The branch in the tarball should be used instead of this. This should be used when no tarball exists.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='patchsets', to='results.Branch'),
        ),
        migrations.AddField(
            model_name='tarball',
            name='branch_link',
            field=models.ForeignKey(blank=True, help_text='DPDK branch that the patch set was applied to', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='tarballs', to='results.Branch'),
        ),
        migrations.AddField(
            model_name='testrun',
            name='branch_link',
            field=models.ForeignKey(blank=True, help_text='The branch of the baseline used', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='runs', to='results.Branch'),
        ),
        # Migration 2
        migrations.RunPython(link_branches, reverse_code=migrations.RunPython.noop),
        # Migration 3
        migrations.RemoveField(
            model_name='patchset',
            name='branch',
        ),
        migrations.RemoveField(
            model_name='tarball',
            name='branch',
        ),
        migrations.RemoveField(
            model_name='testrun',
            name='branch',
        ),
        # Migration 4
        migrations.RenameField(
            model_name='patchset',
            old_name='branch_link',
            new_name='branch',
        ),
        migrations.RenameField(
            model_name='tarball',
            old_name='branch_link',
            new_name='branch',
        ),
        migrations.RenameField(
            model_name='testrun',
            old_name='branch_link',
            new_name='branch',
        ),
    ]
