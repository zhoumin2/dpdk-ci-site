{% extends "base.html" %}

{% block title %}Patchset {{ patchset.id }}{% endblock %}

{% block breadcrumb_items %}
  <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
  <li class="breadcrumb-item active" aria-current="page">Patchset Detail</li>
{% endblock %}

{% block content %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags  }} alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
      {{ message  }}
    </div>
  {% endfor %}
  <h1>Patch Set {{ patchset.patchwork_range_str|safe }}</h1>
  <dl>
    <div class="row">
      <dt class="col">Submitter</dt>
      <dd class="col-10">{{ patchset.submitter }}</dd>
    </div>
    {# patches that fail applying will have the commit id in the patchset (tarball will not be defined) #}
    {% if tarball or patchset.commit_id %}
    <div class="row">
      <dt class="col">Applied on</dt>
      <dd class="col-10">
        {% if tarball %}
        {{ tarball.branch }}
        (<code><a href="{{ tarball.commit_url }}">{{ tarball.commit_id }}</a></code>)
        {% elif patchset.commit_id %}
        {{ patchset.branch }}
        (<code><a href="{{ patchset.commit_url }}">{{ patchset.commit_id }}</a></code>)
        {% endif %}
      </dd>
    </div>
    {% endif %}
    <div class="row">
      <dt class="col">Date submitted</dt>
      <dd class="col-10">{{ patchset.date|date:"DATETIME_FORMAT" }}</dd>
    </div>
    {% if tarball.tarball_url %}
    <div class="row">
      <dt class="col">Tarball</dt>
      <dd class="col-10"><a href="{{ tarball.tarball_url }}">{{ tarball.tarball_name }}</a></dd>
    </div>
    {% endif %}
  </dl>
  <ul>
    {% for p in patchset.patches %}
    <li><a href="https://patches.dpdk.org/patch/{{ p.id }}">{{ p.name }}</a></li>
    {% endfor %}
  </ul>
  <h1>
    Test Results
    <small><span class="badge badge-{{ patchset.status_class }} align-middle">{{ patchset.status }}</span></small>
  </h1>
  {% if patchset.incomplete > 0 or patchset.passed > 0 or patchset.failed > 0 %}
  <p title="Summary of tests: {{ patchset.incomplete }} incomplete, {{ patchset.passed }} passed, and {{ patchset.failed }} failed.">
    <span class="mr-2">Test summary:</span>
    {% for i in patchset.incomplete_range %}
    <span class="bg-secondary px-2 mr-1"></span>
    {% endfor %}
    {% for i in patchset.passed_range %}
    <span class="bg-success px-2 mr-1"></span>
    {% endfor %}
    {% for i in patchset.failed_range %}
    <span class="bg-danger px-2 mr-1"></span>
    {% endfor %}
  </p>
  {% endif %}
  {% if patchset.has_error and user.is_authenticated %}
  <form class="form-inline my-5" action="{% url 'dashboard_rebuild' patchset.id %}?next={% url 'dashboard-detail' patchset.id %}" method="POST">
    {% csrf_token %}
    <div class="form-group">
      <label class="mr-3" for="branch-select">Retry applying patch to</label>
      <select id="branch-select" class="form-control mr-3" name="branch">
        {% for branch in branches %}
        <option value="{{ branch.name }}">{{ branch.name }}</option>
        {% endfor %}
      </select>
    </div>
    <input type="submit" class="btn btn-warning" value="Rebuild">
  </form>
  {% endif %}
  {% if patchset.has_error and patchset.build_log %}
  <pre class="bg-dark text-light p-2">{{ patchset.build_log }}</pre>
  {% else %}
  {% for env_url, environment in environments.items %}
    <div class="card mb-4">
      <h2 class="card-header" id="env-{{ environment.id }}">
        {{ environment.nic_make }} {{ environment.nic_model }} {{ environment.nic_speed }} Mbps
      </h2>
      <div class="card-body">
        {% if 'url' not in r %}
        <p>The tests were not run for this environment.</p>
        {% else %}
          {% if not environment.live_since or environment.live_since > r.timestamp %}
          <p>Note: This run does not affect the overall result above.</p>
          {% endif %}
          {% if environment.hardware_description %}
          <h3><a href="{{ environment.hardware_description }}">Configuration Information</a></h3>
          {% else %}
          <h3>Configuration Information</h3>
          {% endif %}
          <dl>
            <div class="row">
            <dt class="col">Kernel</dt>
            <dd class="col-10">{{ environment.kernel_name }} {{ environment.kernel_version }}</dd>
            </div>
            <div class="row">
            <dt class="col">Compiler</dt>
            <dd class="col-10">{{ environment.compiler_name }} {{ environment.compiler_version }}</dd>
            </div>
            <div class="row">
            <dt class="col">Target</dt>
            <dd class="col-10">x86_64-native-linuxapp-gcc</dd>
            </div>
          </dl>
          {% if environment.runs|length > 0 %}
          <h3>Detailed performance results</h3>
          {% endif %}
          {% if environment.runs|length > 1 %}
          <ul class="nav nav-tabs">
            {% for r in environment.runs %}
            <li class="nav-item">
              <a class="nav-link{{ forloop.first|yesno:' active,' }}" data-toggle="tab" href="#run-{{ r.id }}" role="tab" aria-controls="run-{{ r.id }}" aria-selected="{{ forloop.first|lower }}">
                Run {{ forloop.revcounter }}
              </a>
            </li>
            {% endfor %}
          </ul>
          <div class="tab-content">
            {% for r in environment.runs %}
            <div class="tab-pane fade{{ forloop.first|yesno:' show active,' }}" id="run-{{ r.id }}" role="tabpanel" aria-labelledby="run-{{ r.id }}-tab">
              {% include "test_run.html" %}
            </div>
            {% endfor %}
          </div>
          {% elif environment.runs|length == 1 %}
            {% with environment.runs|first as r %}
              {% include "test_run.html" %}
            {% endwith %}
          {% else %}
          <p>There are not yet any runs for this patch set.</p>
          {% endif %}
        {% endif %}
      </div>
    </div>
  {% empty %}
  <p>There are not yet any runs for this patch set or you do not have
  permission to view detailed results for any test runs for this patch
  set.</p>
  {% endfor %}
  {% endif %}
  {% if environments %}
  <h3>Disclaimers</h3>
  <p>Intel Corporation:</p>
  <blockquote class="blockquote text-muted border-left ml-4">
    <div class="ml-4">
      <p>
        <small>
          Software and workloads used in performance tests may have been
          optimized for performance only on Intel microprocessors.
        </small>
      </p>
      <p>
        <small>
          Performance tests, such as SYSmark and MobileMark, are measured using
          specific computer systems, components, software, operations and
          functions. Any change to any of those factors may cause the results
          to vary. You should consult other information and performance tests
          to assist you in fully evaluating your contemplated purchases,
          including the performance of that product when combined with other
          products. For more complete information visit
          <a href="https://www.intel.com/benchmarks/">www.intel.com/benchmarks</a>.
        </small>
      </p>
      <p>
        <small>
          Performance results are based on testing as of {{ patchset.date|date }}
          and may not reflect all publicly available security updates.
          See configuration disclosure for details.
          No product can be absolutely secure.
        </small>
      </p>
    </div>
  </blockquote>
  <p>Mellanox Technologies:</p>
  <blockquote class="blockquote text-muted border-left ml-4">
    <div class="ml-4">
      <p>
        <small>
          The tests and the results published here which refer to Mellanox'
          products or software, are provided "AS IS". Mellanox disclaims all
          warranties, including, but not limited to, any warranty of title,
          non-infringement, merchantability, security and fitness of any
          results.
        </small>
      </p>
    </div>
  </blockquote>
  {% endif %}
{% endblock %}

{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js" integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin="anonymous"></script>
<script>anchors.add('h2');</script>
{% endblock %}
